#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ VPS
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy-bot.sh

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ BetsBot..."

cd bot

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install --production

# –°–±–æ—Ä–∫–∞ TypeScript (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
if [ ! -d "dist" ]; then
  echo "üî® –°–±–æ—Ä–∫–∞ TypeScript..."
  npm run build
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
  echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.production.example"
  exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if ! command -v pm2 &> /dev/null; then
  echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
  npm install -g pm2
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
pm2 stop betsbot 2>/dev/null || true
pm2 delete betsbot 2>/dev/null || true

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
pm2 start dist/index.js --name betsbot

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
pm2 save

echo "‚úÖ –ë–æ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç!"
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: pm2 status"
echo "üìã –õ–æ–≥–∏: pm2 logs betsbot"
